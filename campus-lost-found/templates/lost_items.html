{% extends "base.html" %}

{% block title %}Lost Items{% endblock %}

{% block content %}
<div class="items-page">
    <div class="container">
        <div class="page-header">
            <h1><span class="title-lost">Lost</span> <span class="title-items">Items</span></h1>
            <a href="{{ url_for('report_lost') }}" class="btn-report lost-btn">
            <img src="{{ url_for('static', filename='icons/lost.png') }}" alt="Report" class="btn-icon-img">
            <span>Report</span>
            </a>
        </div>

        <div class="search-bar">
            <input type="text" id="searchInput" placeholder="Search items..." oninput="searchItems(this.value)">
        </div>

        {% if items %}
        <div class="items-grid" id="itemsGrid">
            {% for item in items %}
            <div class="item-card">
                <div class="card-header">
                    <div class="user-avatar">{{ item.reporter.name[0].upper() }}</div>
                    <div class="user-info">
                        <div class="item-name">{{ item.reporter.name }}</div>
                        <div class="item-date">{{ item.date }}</div>
                    </div>
                    
                    <!-- Updated three-dots menu -->
                    <div class="item-menu">
                        <button class="card-menu" onclick="toggleMenu(event, '{{ item.item_id }}')">â‹®</button>
                        <div class="dropdown-menu" id="menu-{{ item.item_id }}">
                            {% if session.get('user_id') == item.user_id %}
                            <form method="POST" action="{{ url_for('delete_lost', item_id=item.item_id) }}" 
                                  onsubmit="return confirm('Are you sure you want to delete this item?');">
                                <button type="submit" class="dropdown-item delete-btn">
                                    <span></span> Delete Item
                                </button>
                            </form>
                            {% endif %}
                            <a href="{{ url_for('view_matches', item_id=item.item_id, item_type='lost') }}" 
                               class="dropdown-item">
                                <span></span> View Matches
                            </a>
                        </div>
                    </div>
                </div>
                
<div class="card-image" {% if item.photo %}onclick="openImageModal('{{ url_for('static', filename='uploads/' + item.photo) }}', '{{ item.name }}')" style="cursor: pointer;"{% endif %}>
    {% if item.photo %}
    <img src="{{ url_for('static', filename='uploads/' + item.photo) }}" alt="{{ item.name }}">
    {% else %}
    <div class="placeholder-image">
        <div class="shape triangle"></div>
        <div class="shape square"></div>
        <div class="shape circle"></div>
    </div>
    {% endif %}
</div>
                
                <div class="card-body">
                    <div class="item-title">{{ item.name }}</div>
                    <div class="item-location">
                        <img src="{{ url_for('static', filename='icons/location.png') }}" alt="" style="width: 14px; height: 14px; margin-right: 4px; vertical-align: middle;">
                        {{ item.location }}
                    </div>
                    <p class="item-description">{{ item.desc[:100] }}{% if item.desc|length > 100 %}...{% endif %}</p>
                </div>

                <div class="card-footer">
                    <a href="{{ url_for('view_matches', item_id=item.item_id, item_type='lost') }}" class="btn-view-matches">View Matches</a>
                </div>
            </div>
            {% endfor %}
        </div>
        {% else %}
        <div class="no-items">
            <h3>No Lost Items Yet</h3>
            <p>Be the first to report a lost item!</p>
        </div>
        {% endif %}
    </div>
</div>

<script>
function searchItems(query) {
    const cards = document.querySelectorAll('.item-card');
    cards.forEach(card => {
        const title = card.querySelector('.item-title').textContent.toLowerCase();
        const desc = card.querySelector('.item-description').textContent.toLowerCase();
        if (title.includes(query.toLowerCase()) || desc.includes(query.toLowerCase())) {
            card.style.display = 'block';
        } else {
            card.style.display = 'none';
        }
    });
}

function toggleMenu(event, itemId) {
    event.stopPropagation();
    const menu = document.getElementById('menu-' + itemId);
    const allMenus = document.querySelectorAll('.dropdown-menu');
    
    // Close all other menus
    allMenus.forEach(m => {
        if (m.id !== 'menu-' + itemId) {
            m.classList.remove('show');
        }
    });
    
    // Toggle current menu
    menu.classList.toggle('show');
}

// Close menus when clicking outside
document.addEventListener('click', function(event) {
    if (!event.target.closest('.item-menu')) {
        document.querySelectorAll('.dropdown-menu').forEach(menu => {
            menu.classList.remove('show');
        });
    }
});
</script>

<!-- Image Modal -->
<div id="imageModal" class="image-modal" onclick="closeModal()">
    <span class="modal-close">&times;</span>
    <img class="modal-content" id="modalImage">
    <div class="modal-caption" id="modalCaption"></div>
</div>

<script>
function openImageModal(imageSrc, itemName) {
    const modal = document.getElementById('imageModal');
    const modalImg = document.getElementById('modalImage');
    const caption = document.getElementById('modalCaption');
    
    modal.style.display = "flex";
    modalImg.src = imageSrc;
    caption.innerHTML = itemName;
    
    // Prevent body scroll when modal is open
    document.body.style.overflow = 'hidden';
}

function closeModal() {
    const modal = document.getElementById('imageModal');
    modal.style.display = "none";
    document.body.style.overflow = 'auto';
}

// Close modal on Escape key
document.addEventListener('keydown', function(event) {
    if (event.key === 'Escape') {
        closeModal();
    }
});
</script>

{% endblock %}
